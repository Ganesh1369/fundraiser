<!-- Loading -->
@if (loading) {
<div class="loading-state">
    <div class="spinner"></div>
</div>
}

<!-- Error -->
@if (!loading && error) {
<div class="error-state">
    <p class="error-message">{{ error }}</p>
    <button class="btn btn-primary" (click)="loadUser()">Retry</button>
</div>
}

<!-- Content -->
@if (!loading && !error && user) {
<header class="admin-header">
    <a routerLink="/admin/dashboard" class="back-link">&larr; Back to Dashboard</a>
    <h1>User Details</h1>
</header>

<!-- Profile Card -->
<div class="profile-card">
    <div class="profile-avatar">
        @if (user.profile_pic) {
        <img [src]="user.profile_pic" [alt]="user.name" class="avatar-img">
        } @else {
        <span class="avatar-initials">{{ getInitials(user.name) }}</span>
        }
    </div>
    <div class="profile-info">
        <div class="profile-name-row">
            <h2>{{ user.name }}</h2>
            <span class="badge" [ngClass]="user.user_type">{{ user.user_type }}</span>
        </div>
        <div class="profile-details">
            <span class="detail-item">
                <lucide-icon name="mail" class="w-4 h-4"></lucide-icon> {{ user.email }}
            </span>
            @if (user.phone) {
            <span class="detail-item">
                <lucide-icon name="phone" class="w-4 h-4"></lucide-icon> {{ user.phone }}
            </span>
            }
            @if (user.city) {
            <span class="detail-item">
                <lucide-icon name="map-pin" class="w-4 h-4"></lucide-icon> {{ user.city }}
            </span>
            }
            <span class="detail-item">
                <lucide-icon name="calendar" class="w-4 h-4"></lucide-icon> Joined {{ formatDate(user.created_at) }}
            </span>
        </div>
        @if (user.user_type === 'student') {
        <div class="profile-extra">
            @if (user.class_grade) { <span>Class: {{ user.class_grade }}</span> }
            @if (user.school_name) { <span>School: {{ user.school_name }}</span> }
        </div>
        }
        @if (user.user_type === 'organization') {
        <div class="profile-extra">
            @if (user.organization_name) { <span>Org: {{ user.organization_name }}</span> }
            @if (user.pan_number) { <span>PAN: {{ user.pan_number }}</span> }
        </div>
        }
        @if (user.referral_code) {
        <div class="profile-extra">
            <span>Referral Code: <strong>{{ user.referral_code }}</strong></span>
        </div>
        }
    </div>
</div>

<!-- Stats Grid -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-header">
            <lucide-icon name="wallet" class="stat-icon w-5 h-5"></lucide-icon>
            <span class="stat-label">Total Donated</span>
        </div>
        <div class="stat-value">{{ formatCurrency(donations?.totalAmount || 0) }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-header">
            <lucide-icon name="receipt" class="stat-icon w-5 h-5"></lucide-icon>
            <span class="stat-label">Donation Count</span>
        </div>
        <div class="stat-value">{{ donations?.count || 0 }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-header">
            <lucide-icon name="star" class="stat-icon w-5 h-5"></lucide-icon>
            <span class="stat-label">Referral Points</span>
        </div>
        <div class="stat-value">{{ referrals?.points || 0 }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-header">
            <lucide-icon name="users" class="stat-icon w-5 h-5"></lucide-icon>
            <span class="stat-label">People Referred</span>
        </div>
        <div class="stat-value">{{ referrals?.count || 0 }}</div>
    </div>
</div>

<!-- Tabs -->
<div class="tab-bar">
    <button class="tab-btn" [class.active]="activeTab === 'donations'" (click)="activeTab = 'donations'">Donations</button>
    <button class="tab-btn" [class.active]="activeTab === 'referrals'" (click)="activeTab = 'referrals'">Referrals</button>
    <button class="tab-btn" [class.active]="activeTab === 'events'" (click)="activeTab = 'events'">Events</button>
    <button class="tab-btn" [class.active]="activeTab === 'certificates'" (click)="activeTab = 'certificates'">Certificates</button>
</div>

<!-- Donations Tab -->
@if (activeTab === 'donations') {
<div class="card">
    @if (donations?.history?.length === 0) {
    <div class="empty-state">
        <lucide-icon name="wallet" class="empty-icon w-10 h-10"></lucide-icon>
        <h3>No Donations</h3>
        <p>This user has not made any donations yet.</p>
    </div>
    } @else {
    <div class="table-wrapper">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Payment ID</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody>
                @for (d of donations?.history; track d.id) {
                <tr>
                    <td class="amount">{{ formatCurrency(d.amount) }}</td>
                    <td><span class="status-badge" [ngClass]="d.status">{{ d.status }}</span></td>
                    <td>{{ d.razorpay_payment_id || '--' }}</td>
                    <td>{{ formatDate(d.created_at) }}</td>
                </tr>
                }
            </tbody>
        </table>
    </div>
    }
</div>
}

<!-- Referrals Tab -->
@if (activeTab === 'referrals') {
<div class="card">
    @if (!referrals?.users?.length) {
    <div class="empty-state">
        <lucide-icon name="users" class="empty-icon w-10 h-10"></lucide-icon>
        <h3>No Referrals</h3>
        <p>This user has not referred anyone yet.</p>
    </div>
    } @else {
    <div class="table-wrapper">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Type</th>
                    <th>Joined</th>
                    <th>Total Donated</th>
                </tr>
            </thead>
            <tbody>
                @for (u of referrals.users; track u.id) {
                <tr>
                    <td class="name-cell"><a [routerLink]="['/admin/users', slugify(u.name)]" [state]="{userId: u.id}" class="user-link">{{ u.name }}</a></td>
                    <td>{{ u.email }}</td>
                    <td><span class="badge" [ngClass]="u.user_type">{{ u.user_type }}</span></td>
                    <td>{{ formatDate(u.created_at) }}</td>
                    <td class="amount">{{ formatCurrency(u.total_donated) }}</td>
                </tr>
                }
            </tbody>
        </table>
    </div>
    }
</div>
}

<!-- Events Tab -->
@if (activeTab === 'events') {
<div class="card">
    @if (eventRegistrations.length === 0) {
    <div class="empty-state">
        <lucide-icon name="calendar" class="empty-icon w-10 h-10"></lucide-icon>
        <h3>No Event Registrations</h3>
        <p>This user has not registered for any events.</p>
    </div>
    } @else {
    <div class="table-wrapper">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Event Name</th>
                    <th>Type</th>
                    <th>Event Date</th>
                    <th>Registration Status</th>
                </tr>
            </thead>
            <tbody>
                @for (er of eventRegistrations; track er.event_id) {
                <tr>
                    <td class="name-cell">{{ er.event_name }}</td>
                    <td><span class="badge">{{ er.event_type }}</span></td>
                    <td>{{ formatDate(er.event_date) }}</td>
                    <td><span class="status-badge" [ngClass]="'reg-' + er.registration_status">{{ er.registration_status }}</span></td>
                </tr>
                }
            </tbody>
        </table>
    </div>
    }
</div>
}

<!-- Certificates Tab -->
@if (activeTab === 'certificates') {
<div class="card">
    @if (certificates.length === 0) {
    <div class="empty-state">
        <lucide-icon name="file-text" class="empty-icon w-10 h-10"></lucide-icon>
        <h3>No Certificate Requests</h3>
        <p>This user has not requested any certificates.</p>
    </div>
    } @else {
    <div class="table-wrapper">
        <table class="data-table">
            <thead>
                <tr>
                    <th>PAN</th>
                    <th>Donation Amount</th>
                    <th>Status</th>
                    <th>Requested</th>
                </tr>
            </thead>
            <tbody>
                @for (c of certificates; track c.id) {
                <tr>
                    <td>{{ c.pan_number }}</td>
                    <td class="amount">{{ c.donation_amount ? formatCurrency(c.donation_amount) : '--' }}</td>
                    <td><span class="status-badge" [ngClass]="getCertStatusClass(c.status)">{{ c.status }}</span></td>
                    <td>{{ formatDate(c.requested_at) }}</td>
                </tr>
                }
            </tbody>
        </table>
    </div>
    }
</div>
}
}
